<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®Œæ•´æµ‹è¯•ï¼šä¸Šä¼ å¹¶æŸ¥çœ‹ä»²è£</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        button { padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #2980b9; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 5px; }
        .file-preview { display: inline-block; margin: 5px; padding: 10px; background: #e8f5e9; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>å®Œæ•´æµ‹è¯•æµç¨‹</h1>
    
    <div class="section">
        <h2>æ­¥éª¤1: ä¸Šä¼ æµ‹è¯•æ–‡ä»¶</h2>
        <input type="file" id="fileInput" accept="image/*,.pdf" multiple>
        <button onclick="uploadFiles()">ä¸Šä¼ æ–‡ä»¶</button>
        <div id="uploadResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤2: åˆ›å»ºä»²è£ç”³è¯·</h2>
        <button onclick="createArbitration()">åˆ›å»ºæµ‹è¯•ä»²è£</button>
        <div id="createResult" class="result" style="display:none;"></div>
    </div>
    
    <div class="section">
        <h2>æ­¥éª¤3: æŸ¥çœ‹ä»²è£è¯¦æƒ…</h2>
        <button onclick="viewArbitration()">æŸ¥çœ‹æœ€æ–°ä»²è£</button>
        <div id="viewResult" class="result" style="display:none;"></div>
    </div>

    <script>
        let uploadedFiles = [];
        
        async function uploadFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            for (let file of files) {
                formData.append('files', file);
            }
            
            try {
                const response = await fetch('http://localhost:4000/api/upload-arbitration-files', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                uploadedFiles = data.files;
                
                const resultDiv = document.getElementById('uploadResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = '<h3>âœ… ä¸Šä¼ æˆåŠŸ</h3>' + 
                    uploadedFiles.map(f => `<div class="file-preview">ğŸ“ ${f.originalName}</div>`).join('');
                
            } catch (error) {
                alert('ä¸Šä¼ å¤±è´¥: ' + error.message);
            }
        }
        
        async function createArbitration() {
            if (uploadedFiles.length === 0) {
                alert('è¯·å…ˆä¸Šä¼ æ–‡ä»¶');
                return;
            }
            
            const evidence = uploadedFiles.map(f => JSON.stringify(f));
            
            try {
                const response = await fetch('http://localhost:4000/api/arbitration-requests', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        applicant_id: 2,
                        order_type: 'farmer_report',
                        order_id: 999,
                        order_no: 'TEST-' + Date.now(),
                        reason: 'quality',
                        description: 'è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„æµ‹è¯•ï¼ŒåŒ…å«çœŸå®ä¸Šä¼ çš„æ–‡ä»¶',
                        evidence_trade: evidence,
                        evidence_material: evidence,
                        evidence_payment: evidence,
                        evidence_communication: [],
                        evidence_other: []
                    })
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('createResult');
                resultDiv.style.display = 'block';
                resultDiv.innerHTML = `<h3>âœ… ä»²è£å·²åˆ›å»º</h3><p>ID: ${data.id}<br>ç¼–å·: ${data.arbitration_no}</p>`;
                
                window.lastArbitrationId = data.id;
                
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥: ' + error.message);
            }
        }
        
        async function viewArbitration() {
            if (!window.lastArbitrationId) {
                alert('è¯·å…ˆåˆ›å»ºä»²è£');
                return;
            }
            
            try {
                const response = await fetch('http://localhost:4000/api/arbitration-requests/all?status=all');
                const data = await response.json();
                const item = data.find(x => x.id === window.lastArbitrationId);
                
                if (!item) {
                    alert('æœªæ‰¾åˆ°ä»²è£è®°å½•');
                    return;
                }
                
                const resultDiv = document.getElementById('viewResult');
                resultDiv.style.display = 'block';
                
                let html = '<h3>ğŸ“ è¯æ®ææ–™</h3>';
                
                const renderFiles = (files, title) => {
                    if (!files || files.length === 0) return '';
                    
                    let result = `<h4>${title}</h4>`;
                    files.forEach(fileStr => {
                        const fileInfo = JSON.parse(fileStr);
                        result += `
                            <div class="file-preview" onclick="previewFile('${fileInfo.path}', '${fileInfo.originalName}')" 
                                 style="cursor: pointer;">
                                ğŸ–¼ï¸ ${fileInfo.originalName} <span style="color:#3498db;">ç‚¹å‡»æŸ¥çœ‹</span>
                            </div>
                        `;
                    });
                    return result;
                };
                
                html += renderFiles(item.evidence_trade, 'äº¤æ˜“å‡­è¯');
                html += renderFiles(item.evidence_material, 'ç‰©æ–™è¯æ˜');
                html += renderFiles(item.evidence_payment, 'ä»˜æ¬¾å‡­è¯');
                
                resultDiv.innerHTML = html;
                
            } catch (error) {
                alert('æŸ¥çœ‹å¤±è´¥: ' + error.message);
            }
        }
        
        function previewFile(path, name) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            modal.innerHTML = `
                <div style="position: relative; max-width: 90%; max-height: 90%; background: white; padding: 20px; border-radius: 10px;">
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="position: absolute; top: 10px; right: 10px;">å…³é—­</button>
                    <h3>${name}</h3>
                    <img src="http://localhost:4000${path}" style="max-width: 100%; max-height: 70vh;" 
                         onerror="this.outerHTML='<p style=color:red>å›¾ç‰‡åŠ è½½å¤±è´¥</p>'">
                </div>
            `;
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>
