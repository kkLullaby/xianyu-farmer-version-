# 系统架构详解

## 📐 项目架构图

```
┌─────────────────────────────────────────────────────────────┐
│                     农业废品回收平台                         │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                   index.html                          │  │
│  │           (页面结构 + 登录/注册弹窗)                 │  │
│  └──────────────────────────────────────────────────────┘  │
│                           │                                 │
│           ┌───────────────┼───────────────┐               │
│           ↓               ↓               ↓               │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐     │
│  │  auth.js     │ │ main_code.js │ │  HTML DOM   │     │
│  │              │ │              │ │             │     │
│  │ 身份认证     │ │ 业务逻辑     │ │ 页面元素    │     │
│  │ 权限验证     │ │ 导航菜单     │ │ 内容显示    │     │
│  │ 分流转向     │ │ 表单处理     │ │ 用户交互    │     │
│  └──────────────┘ └──────────────┘ └──────────────┘     │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 🔄 用户流程图

### 完整登录流程

```
用户打开网页
    │
    ↓
authSystem.init()
    │
    ├─ 检查 sessionStorage 中是否有用户信息
    │  ├─ YES → 已登录，跳转到仪表板
    │  └─ NO → 显示登录页面
    │
    ↓
用户点击"登录"按钮
    │
    ↓
authSystem.openLoginModal()
    ├─ 打开登录弹窗
    └─ 显示三个测试账号
    │
    ↓
用户输入账号密码
    │
    ↓
点击"立即登录"
    │
    ↓
authSystem.handleLogin()
    │
    ├─ 验证用户名是否存在
    │  └─ 不存在 → 显示 "用户名不存在"
    │
    ├─ 验证密码是否正确
    │  └─ 错误 → 显示 "密码错误"
    │
    ├─ YES → 创建用户会话
    │  ├─ 保存到 sessionStorage
    │  ├─ 更新导航栏
    │  ├─ 显示成功提示
    │  └─ 关闭登录弹窗
    │
    ↓
authSystem.redirectToDashboard()
    │
    ├─ 检查 currentUser.role
    │  ├─ 'admin' → showAdminDashboard()
    │  ├─ 'farmer' → showFarmerDashboard()
    │  └─ 'recycler' → showRecyclerDashboard()
    │
    ↓
显示对应身份的工作台
    │
    ├─ 加载不同的侧边栏菜单
    ├─ 显示对应的功能卡片
    └─ 更新导航栏用户信息

```

---

## 🎯 身份认证体系

### 1. 数据结构

```javascript
// 用户数据库
authSystem.users = {
    'admin001': {
        password: 'admin123',      // 密码
        role: 'admin',             // 身份
        name: '系统管理员'          // 显示名称
    },
    'farmer001': {
        password: 'farmer123',
        role: 'farmer',
        name: '李农户'
    },
    'recycler001': {
        password: 'recycler123',
        role: 'recycler',
        name: '王回收商'
    }
}

// 当前登录用户
authSystem.currentUser = {
    username: 'admin001',          // 用户名
    role: 'admin',                 // 身份
    name: '系统管理员',            // 显示名称
    loginTime: '2026-01-09 10:30'  // 登录时间
}
```

### 2. 会话存储

```
┌─────────────────────────────────┐
│      sessionStorage              │
│  (浏览器标签页关闭时清除)       │
│                                 │
│  Key: 'currentUser'             │
│  Value: {                       │
│    username: 'admin001',        │
│    role: 'admin',               │
│    name: '系统管理员',          │
│    loginTime: '...'             │
│  }                              │
└─────────────────────────────────┘
```

---

## 🎨 三身份工作台架构

### 1. 管理员工作台 (admin)

```
┌─────────────────────────────────────────┐
│         管理员工作台                     │
│  (颜色主题: 红色 #e74c3c)               │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  📊 概览    │  │  👥 用户管理│     │
│  │ • 用户总数  │  │ • 审核用户  │     │
│  │ • 农户数    │  │ • 禁用/删除 │     │
│  │ • 回收商    │  │             │     │
│  │ • 待审核    │  └─────────────┘     │
│  └─────────────┘                       │
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  📝 审核    │  │  📈 统计    │     │
│  │ • 审核申报  │  │ • 处理量    │     │
│  │ • 核实数据  │  │ • 活跃度    │     │
│  │             │  │             │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │      ⚙️ 系统设置                 │   │
│  │ • 配置处理点、费用等             │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘

侧边栏菜单:
├─ 📊 仪表板
├─ 👥 用户管理
├─ 📝 申报审核
├─ 📈 数据统计
├─ ⚙️ 系统设置
└─ 🚪 退出登录
```

### 2. 农户工作台 (farmer)

```
┌─────────────────────────────────────────┐
│         农户工作台                       │
│  (颜色主题: 绿色 #27ae60)               │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  📊 我的统计│  │  📝 申报    │     │
│  │ • 处理总量  │  │ • 新建申报  │     │
│  │ • 申报数    │  │ • 处理凭证  │     │
│  │ • 批准/待审 │  │             │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  📋 记录    │  │  🗺️ 处理点 │     │
│  │ • 历史申报  │  │ • 查找处理点│     │
│  │ • 跟踪状态  │  │ • 费用信息  │     │
│  │             │  │             │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │      👤 我的账户                 │   │
│  │ • 个人信息、密码修改             │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘

侧边栏菜单:
├─ 🏠 我的首页
├─ 📝 发起申报
├─ 📋 申报记录
├─ 🗺️ 处理点查询
├─ 👤 我的账户
└─ 🚪 退出登录
```

### 3. 回收商工作台 (recycler)

```
┌─────────────────────────────────────────┐
│         回收商工作台                     │
│  (颜色主题: 青绿 #1abc9c)               │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  📊 我的统计│  │  📢 求购    │     │
│  │ • 回收总量  │  │ • 发布需求  │     │
│  │ • 合作农户  │  │ • 吸引投资  │     │
│  │ • 交易数    │  │             │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌─────────────┐  ┌─────────────┐     │
│  │  📦 订单    │  │  🤝 农户    │     │
│  │ • 管理订单  │  │ • 合作关系  │     │
│  │ • 交易进度  │  │ • 评价信息  │     │
│  │             │  │             │     │
│  └─────────────┘  └─────────────┘     │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │      💰 财务中心                 │   │
│  │ • 账单查询、收款管理             │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │      👤 我的账户                 │   │
│  │ • 企业信息、密码修改             │   │
│  └─────────────────────────────────┘   │
│                                         │
└─────────────────────────────────────────┘

侧边栏菜单:
├─ 🏠 我的首页
├─ 📢 发布求购
├─ 📦 订单管理
├─ 🤝 合作农户
├─ 💰 财务中心
├─ 👤 我的账户
└─ 🚪 退出登录
```

---

## 🔐 权限控制流程

```
用户访问受保护的功能
    │
    ↓
检查 authSystem.currentUser 是否存在
    │
    ├─ NULL (未登录)
    │  └─ 显示登录提示，不允许访问
    │
    └─ 存在 (已登录)
       │
       ├─ 检查 role 是否有权限
       │  ├─ YES → 允许访问，显示对应内容
       │  └─ NO → 显示"无权限"提示
       │
       ↓
    获取该身份可用的菜单和功能
       │
       ├─ admin → 管理员菜单
       ├─ farmer → 农户菜单
       └─ recycler → 回收商菜单
```

---

## 📚 代码调用链

### 初始化流程

```
index.html 加载完成
    │
    ↓ <script src="auth.js"></script>
    ├─ authSystem 对象创建
    │
    ↓ DOMContentLoaded 事件触发
    ├─ authSystem.init()
    │  ├─ authSystem.checkLoginStatus()
    │  │  ├─ 读取 sessionStorage
    │  │  ├─ 有登录信息 → redirectToDashboard()
    │  │  └─ 无登录信息 → 显示首页
    │  │
    │  └─ authSystem.bindLoginEvents()
    │     └─ 给"登录"按钮绑定事件监听
    │
    ↓ <script src="main_code.js"></script>
    └─ initNavigation()
       └─ 给导航菜单项绑定事件监听
```

### 登录流程

```
用户点击"立即登录"
    │
    ↓ onclick="authSystem.handleLogin()"
    ├─ 读取表单中的 username 和 password
    │
    ├─ 检查 authSystem.users[username]
    │
    ├─ 验证密码 users[username].password === password
    │
    ├─ 创建 currentUser 对象
    │
    ├─ sessionStorage.setItem('currentUser', JSON.stringify(currentUser))
    │
    ├─ authSystem.updateNavbar()
    │  └─ 改为显示"👤 用户名"和"退出登录"
    │
    ├─ authSystem.closeLoginModal()
    │
    ├─ 显示成功提示
    │
    └─ 2秒后调用 authSystem.redirectToDashboard()
       └─ 根据 role 调用对应函数显示工作台
```

---

## 🎯 功能扩展指南

### 添加新的管理员功能

1. **更新侧边栏菜单** (在 auth.js 中修改)
```javascript
if (role === 'admin') {
    menuHTML = `
        ...现有菜单...
        <li><a href="#" onclick="authSystem.navigateTo('new-feature')">✨ 新功能</a></li>
    `;
}
```

2. **添加页面逻辑** (在 navigateTo() 函数中)
```javascript
'new-feature': () => {
    container.innerHTML = '<h2>新功能</h2><p>内容...</p>';
}
```

3. **在仪表板中添加卡片** (在 showAdminDashboard() 函数中)
```javascript
<!-- 新功能卡片 -->
<div onclick="authSystem.navigateTo('new-feature')" style="...">
    <h3>✨ 新功能</h3>
    <p>功能说明</p>
    <button>进入</button>
</div>
```

---

## 🔗 文件之间的调用关系

```
index.html
    │
    ├─ 引入 auth.js
    │  ├─ 定义 authSystem 对象
    │  ├─ 包含所有认证逻辑
    │  └─ 暴露给全局作用域
    │
    ├─ 引入 main_code.js
    │  ├─ 定义业务逻辑函数
    │  ├─ 调用 initNavigation()
    │  └─ 使用 authSystem 提供的方法
    │
    └─ 包含登录/注册弹窗 HTML
       └─ 被 authSystem 的方法操作

main_code.js 可调用的 authSystem 方法：
├─ authSystem.navigateTo(page)
├─ authSystem.redirectToDashboard()
├─ authSystem.logout()
├─ authSystem.currentUser
└─ authSystem.showAlert(msg, type)

auth.js 可调用的 main_code.js 函数：
├─ renderReportForm()
└─ submitReport()
```

---

## 💾 数据持久化方案

### 当前方案（内存存储）
```
sessionStorage
    ├─ 优点：简单、快速、安全性好
    ├─ 缺点：刷新页面后丢失
    └─ 适用：演示和测试
```

### 改进方案（后端存储）
```
后端数据库
    ├─ 优点：持久化、真实业务数据
    ├─ 缺点：需要API支持
    └─ 实现：修改 handleLogin() 函数，改用 fetch API

// 伪代码示例
handleLogin() {
    fetch('/api/login', {
        method: 'POST',
        body: JSON.stringify({username, password})
    })
    .then(res => res.json())
    .then(data => {
        this.currentUser = data.user;
        sessionStorage.setItem('currentUser', JSON.stringify(data.user));
        this.redirectToDashboard();
    })
}
```

---

## ✅ 总结

这个系统提供了：
- ✅ 完整的三身份认证
- ✅ 自动权限分流
- ✅ 个性化工作台
- ✅ 灵活的扩展性
- ✅ 易于集成后端

**下一步**：根据具体业务需求继续开发各功能页面！
