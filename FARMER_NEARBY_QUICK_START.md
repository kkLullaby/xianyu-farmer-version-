# 🚀 农户附近处理点功能 - 快速开始

## 📌 功能说明

农户可以查看附近最近的3-5个处理点（回收商），包括：
- 📍 距离（km）
- 📞 联系电话（支持直接拨号）
- 🏢 详细地址
- ⏰ 营业时间
- 🗺️ 驾车路线（需配置地图API）

---

## ⚡ 5分钟快速体验

### 第1步：启动服务（10秒）

打开终端，运行：

```bash
cd "/home/kk/code/Project Ex-class"
node server.js &
python3 -m http.server 8080 --bind 127.0.0.1 &
```

或直接运行：
```bash
bash test-farmer-nearby.sh
```

### 第2步：打开页面（5秒）

在浏览器打开：
```
http://127.0.0.1:8080/farmer-nearby-recyclers.html
```

### 第3步：查看结果（1秒）

页面会自动：
1. 获取你的当前位置（或使用默认位置北京）
2. 从后端API获取5个最近的处理点
3. 显示处理点信息卡片

✅ **完成！** 你现在可以体验完整功能。

---

## 🎯 核心功能使用

### 1️⃣ 查看附近处理点

页面会自动显示按距离排序的处理点卡片。

**显示信息**:
- 🏢 处理点名称
- 📏 距离（km）
- 📞 联系电话（可点击拨号）
- 📍 详细地址
- ⏰ 营业时间

### 2️⃣ 拨打电话

点击任意卡片上的 **"📞 拨打电话"** 按钮：
- **手机**: 自动调起拨号界面
- **电脑**: 使用Skype或其他VoIP应用

### 3️⃣ 查看驾车路线

点击任意卡片上的 **"🗺️ 查看路线"** 按钮：
- 地图自动显示你的位置（起点）
- 显示处理点位置（终点）
- 规划驾车路线
- 显示距离、时间等详情

> ⚠️ **地图功能需要配置API Key**，见下文

---

## 🗺️ 配置地图API（可选但推荐）

### 快速配置（3步）

#### Step 1: 获取API Key（2分钟）

1. 访问 https://lbs.amap.com/
2. 注册或登录账号
3. 创建应用，获取API Key（类似：`a1b2c3d4e5f6g7h8`）

#### Step 2: 配置域名白名单（30秒）

在高德开放平台：
- 点击你的应用
- 点击"编辑"
- 添加域名白名单：`localhost, 127.0.0.1`

#### Step 3: 更新代码（20秒）

打开 `farmer-nearby-recyclers.html`，找到第241行：

**修改前**:
```html
<script src="https://webapi.amap.com/maps?v=2.0&key=YOUR_AMAP_KEY&plugin=AMap.Driving"></script>
```

**修改后** (将 `YOUR_AMAP_KEY` 替换为你的实际Key):
```html
<script src="https://webapi.amap.com/maps?v=2.0&key=a1b2c3d4e5f6g7h8&plugin=AMap.Driving"></script>
```

✅ **完成！** 刷新页面，地图功能现在可以使用。

### 如果暂时没有Key

功能仍然可以使用，只是：
- ✅ 显示附近处理点 - 正常
- ✅ 拨打电话 - 正常
- ❌ 查看地图路线 - 需要API Key

---

## 🧪 测试场景

### 场景1: 基础功能测试

1. 打开 `http://127.0.0.1:8080/farmer-nearby-recyclers.html`
2. 等待2秒，查看是否出现5张处理点卡片
3. 检查每张卡片是否包含：名称、距离、电话、地址、营业时间

✅ **预期结果**: 显示5张卡片

### 场景2: 电话功能测试

1. 点击任意卡片的"拨打电话"按钮
2. 观察浏览器反应

✅ **预期结果**: 
- 手机：调起拨号界面
- 电脑：可能提示使用应用或打开Skype

### 场景3: 地图功能测试（需API Key）

1. 点击任意卡片的"查看路线"按钮
2. 等待2秒
3. 检查地图是否显示

✅ **预期结果**: 
- 显示地图
- 显示起点（绿色）和终点（红色）标记
- 显示蓝色驾车路线
- 显示路线详情

### 场景4: 移动设备测试

1. 使用手机浏览器打开页面
2. 允许位置权限
3. 验证功能是否正常

✅ **预期结果**: 布局自适应，功能正常

---

## 📊 测试数据

系统包含5个测试回收商，分布在中国各地：

| 地点 | 商家名称 | 电话 | 距离(从北京) |
|------|---------|------|-------------|
| 北京 | 王回收商 | 13800138001 | 0 km |
| 上海 | 张回收商 | 13800138002 | 1067 km |
| 广州 | 李回收站 | 13800138003 | 1889 km |
| 成都 | 赵处理厂 | 13800138004 | 1525 km |
| 深圳 | 刘环保中心 | 13800138005 | 1959 km |

**使用默认位置**: 北京 (39.9042°N, 116.4074°E)

---

## 🔧 技术细节

### 后端API

**端点**: `GET /api/recyclers/nearby`

**参数**:
- `lat`: 纬度 (必需)
- `lng`: 经度 (必需)
- `limit`: 返回数量，默认5 (可选)

**示例请求**:
```bash
wget -O- "http://localhost:4000/api/recyclers/nearby?lat=39.9042&lng=116.4074&limit=5"
```

**返回数据** (JSON格式):
```json
[
  {
    "id": 3,
    "name": "王回收商",
    "phone": "13800138001",
    "address": "北京市朝阳区回收中心",
    "businessHours": "8:00-18:00",
    "latitude": 39.9042,
    "longitude": 116.4074,
    "distance": 0.0
  }
]
```

### 距离计算

使用 **Haversine公式** 计算地球表面两点间的实际距离：

$$d = 2R \cdot \arcsin\left(\sqrt{\sin^2\left(\frac{\Delta\phi}{2}\right) + \cos\phi_1 \cdot \cos\phi_2 \cdot \sin^2\left(\frac{\Delta\lambda}{2}\right)}\right)$$

其中 R = 6371 km（地球半径）

---

## 📁 文件说明

| 文件 | 说明 |
|------|------|
| `farmer-nearby-recyclers.html` | 农户附近处理点页面 |
| `server.js` | 后端API服务（已添加新端点） |
| `MAP_API_GUIDE.md` | 地图API详细接入指南 |
| `FARMER_NEARBY_GUIDE.md` | 功能使用指南 |
| `FARMER_NEARBY_IMPLEMENTATION.md` | 实现技术总结 |
| `test-farmer-nearby.sh` | 功能自动化测试脚本 |
| `db/add_recyclers.sql` | 回收商数据SQL脚本 |

---

## ⚡ 常见问题

### Q: 页面一直显示"正在获取位置"？
**A**: 
1. 检查浏览器是否弹出定位权限提示，点击允许
2. 如果10秒后仍无反应，检查后端是否运行（`ps aux | grep node`）

### Q: 显示"找到0个附近处理点"？
**A**: 
1. 检查数据库中是否有回收商数据
2. 运行 `sqlite3 data/agri.db "SELECT * FROM users WHERE role_id=3;"`
3. 如果没有数据，运行 `sqlite3 data/agri.db < db/add_recyclers.sql`

### Q: 地图功能不工作？
**A**: 需要配置API Key，参考上文"配置地图API"部分

### Q: 手机上拨打电话功能不工作？
**A**: 
1. 确保是真实手机（不是模拟器）
2. 确保号码格式正确（13开头的11位数字）
3. 尝试长按号码复制，手动拨号

---

## 🚀 后续功能扩展

可以考虑的增强功能：

- [ ] 实时路况显示
- [ ] 多种出行方式（步行、骑行、公交）
- [ ] 处理点评价和评分
- [ ] 在线预约功能
- [ ] 价格比较
- [ ] 收藏功能
- [ ] 分享功能

---

## 📞 获取帮助

1. **查看详细文档**:
   - `FARMER_NEARBY_GUIDE.md` - 完整功能指南
   - `MAP_API_GUIDE.md` - 地图API接入指南

2. **运行测试脚本**:
   ```bash
   bash test-farmer-nearby.sh
   ```

3. **查看浏览器控制台**:
   - 按 F12 打开开发者工具
   - 查看 Console 标签页中的错误信息

---

## ✅ 功能清单

- [x] 后端API实现
- [x] 前端页面设计
- [x] 地理定位功能
- [x] 距离计算
- [x] 电话拨打功能
- [x] 地图集成
- [x] 响应式设计
- [x] 错误处理
- [x] 自动化测试
- [x] 完整文档

---

**准备好了吗？** 🎉

打开浏览器，访问：
```
http://127.0.0.1:8080/farmer-nearby-recyclers.html
```

开始体验吧！
