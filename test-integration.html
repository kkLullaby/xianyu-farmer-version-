<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰åç«¯é›†æˆæµ‹è¯•</title>
    <style>
        body {
            font-family: "Microsoft YaHei", sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            border-bottom: 3px solid #1abc9c;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #1abc9c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background: #16a085;
        }
        .code {
            background: #2c3e50;
            color: #1abc9c;
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            margin: 10px 0;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”— å†œä¸šåºŸå“å›æ”¶å¹³å° - å‰åç«¯é›†æˆæµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“¡ æœåŠ¡çŠ¶æ€æ£€æŸ¥</h2>
            <button onclick="checkBackendHealth()">æ£€æŸ¥åç«¯æœåŠ¡</button>
            <div id="health-result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ” ç™»å½•åŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testLogin('admin001', 'admin123', 'admin')">æµ‹è¯•ç®¡ç†å‘˜ç™»å½•</button>
            <button onclick="testLogin('farmer001', 'farmer123', 'farmer')">æµ‹è¯•å†œæˆ·ç™»å½•</button>
            <button onclick="testLogin('recycler001', 'recycler123', 'recycler')">æµ‹è¯•å›æ”¶å•†ç™»å½•</button>
            <button onclick="testLogin('wronguser', 'wrongpass', null)">æµ‹è¯•é”™è¯¯ç™»å½•</button>
            <div id="login-result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ æ³¨å†ŒåŠŸèƒ½æµ‹è¯•</h2>
            <button onclick="testRegister()">æµ‹è¯•æ³¨å†Œæ–°ç”¨æˆ·</button>
            <div id="register-result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“¦ è®¢å•æŸ¥è¯¢æµ‹è¯•</h2>
            <button onclick="testGetOrders()">æŸ¥è¯¢æ‰€æœ‰è®¢å•</button>
            <button onclick="testGetLocations()">æŸ¥è¯¢åœ°ç‚¹åˆ—è¡¨</button>
            <div id="order-result"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ å®Œæ•´æµç¨‹æµ‹è¯•</h2>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="full-test-result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:4000';

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message;
            element.appendChild(resultDiv);
        }

        function clearResult(elementId) {
            document.getElementById(elementId).innerHTML = '';
        }

        async function checkBackendHealth() {
            clearResult('health-result');
            try {
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                if (data.status === 'ok') {
                    showResult('health-result', 'âœ… åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸', 'success');
                } else {
                    showResult('health-result', 'âŒ åç«¯æœåŠ¡çŠ¶æ€å¼‚å¸¸', 'error');
                }
            } catch (error) {
                showResult('health-result', `âŒ æ— æ³•è¿æ¥åç«¯æœåŠ¡: ${error.message}`, 'error');
            }
        }

        async function testLogin(username, password, expectedRole) {
            clearResult('login-result');
            showResult('login-result', `ğŸ”„ æ­£åœ¨æµ‹è¯•ç™»å½•: ${username}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    if (data.role === expectedRole) {
                        showResult('login-result', 
                            `âœ… ç™»å½•æˆåŠŸ<br>` +
                            `ç”¨æˆ·: ${data.username}<br>` +
                            `å§“å: ${data.full_name}<br>` +
                            `è§’è‰²: ${data.role}<br>` +
                            `ID: ${data.id}`, 
                            'success'
                        );
                    } else {
                        showResult('login-result', 
                            `âš ï¸ ç™»å½•æˆåŠŸä½†è§’è‰²ä¸ç¬¦<br>æœŸæœ›: ${expectedRole}<br>å®é™…: ${data.role}`, 
                            'error'
                        );
                    }
                } else {
                    if (expectedRole === null) {
                        showResult('login-result', 
                            `âœ… æ­£ç¡®æ‹’ç»é”™è¯¯ç™»å½•<br>é”™è¯¯ä¿¡æ¯: ${data.error}`, 
                            'success'
                        );
                    } else {
                        showResult('login-result', 
                            `âŒ ç™»å½•å¤±è´¥: ${data.error}`, 
                            'error'
                        );
                    }
                }
            } catch (error) {
                showResult('login-result', `âŒ è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testRegister() {
            clearResult('register-result');
            const randomNum = Math.floor(Math.random() * 10000);
            const testUser = {
                username: `testuser${randomNum}`,
                password: 'test123',
                role: 'farmer',
                full_name: `æµ‹è¯•ç”¨æˆ·${randomNum}`
            };
            
            showResult('register-result', `ğŸ”„ æ­£åœ¨æ³¨å†Œ: ${testUser.username}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showResult('register-result', 
                        `âœ… æ³¨å†ŒæˆåŠŸ<br>ç”¨æˆ·ID: ${data.id}<br>ç”¨æˆ·å: ${data.username}`, 
                        'success'
                    );
                    
                    // æµ‹è¯•æ–°ç”¨æˆ·ç™»å½•
                    setTimeout(async () => {
                        showResult('register-result', `ğŸ”„ æµ‹è¯•æ–°ç”¨æˆ·ç™»å½•...`, 'info');
                        const loginResponse = await fetch(`${API_BASE}/api/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                username: testUser.username,
                                password: testUser.password
                            })
                        });
                        
                        const loginData = await loginResponse.json();
                        if (loginResponse.ok) {
                            showResult('register-result', 
                                `âœ… æ–°ç”¨æˆ·ç™»å½•æˆåŠŸ<br>` +
                                `å§“å: ${loginData.full_name}<br>` +
                                `è§’è‰²: ${loginData.role}`, 
                                'success'
                            );
                        } else {
                            showResult('register-result', 
                                `âŒ æ–°ç”¨æˆ·ç™»å½•å¤±è´¥: ${loginData.error}`, 
                                'error'
                            );
                        }
                    }, 500);
                    
                } else {
                    showResult('register-result', 
                        `âŒ æ³¨å†Œå¤±è´¥: ${data.error}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('register-result', `âŒ è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testGetOrders() {
            clearResult('order-result');
            showResult('order-result', 'ğŸ”„ æ­£åœ¨æŸ¥è¯¢è®¢å•...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/orders`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('order-result', 
                        `âœ… æŸ¥è¯¢æˆåŠŸï¼Œå…± ${data.length} æ¡è®¢å•<br>` +
                        `<div class="code"><pre>${JSON.stringify(data, null, 2)}</pre></div>`, 
                        'success'
                    );
                } else {
                    showResult('order-result', `âŒ æŸ¥è¯¢å¤±è´¥`, 'error');
                }
            } catch (error) {
                showResult('order-result', `âŒ è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function testGetLocations() {
            clearResult('order-result');
            showResult('order-result', 'ğŸ”„ æ­£åœ¨æŸ¥è¯¢åœ°ç‚¹...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/locations`);
                const data = await response.json();
                
                if (response.ok) {
                    showResult('order-result', 
                        `âœ… æŸ¥è¯¢æˆåŠŸï¼Œå…± ${data.length} ä¸ªåœ°ç‚¹<br>` +
                        `<div class="code"><pre>${JSON.stringify(data, null, 2)}</pre></div>`, 
                        'success'
                    );
                } else {
                    showResult('order-result', `âŒ æŸ¥è¯¢å¤±è´¥`, 'error');
                }
            } catch (error) {
                showResult('order-result', `âŒ è¯·æ±‚é”™è¯¯: ${error.message}`, 'error');
            }
        }

        async function runFullTest() {
            clearResult('full-test-result');
            const results = [];
            
            showResult('full-test-result', '<h3>ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•...</h3>', 'info');
            
            // Test 1: Health Check
            try {
                const health = await fetch(`${API_BASE}/health`);
                const healthData = await health.json();
                results.push({
                    test: 'åç«¯å¥åº·æ£€æŸ¥',
                    passed: healthData.status === 'ok'
                });
            } catch (e) {
                results.push({ test: 'åç«¯å¥åº·æ£€æŸ¥', passed: false, error: e.message });
            }
            
            // Test 2: Admin Login
            try {
                const admin = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'admin001', password: 'admin123' })
                });
                const adminData = await admin.json();
                results.push({
                    test: 'ç®¡ç†å‘˜ç™»å½•',
                    passed: admin.ok && adminData.role === 'admin'
                });
            } catch (e) {
                results.push({ test: 'ç®¡ç†å‘˜ç™»å½•', passed: false, error: e.message });
            }
            
            // Test 3: Farmer Login
            try {
                const farmer = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'farmer001', password: 'farmer123' })
                });
                const farmerData = await farmer.json();
                results.push({
                    test: 'å†œæˆ·ç™»å½•',
                    passed: farmer.ok && farmerData.role === 'farmer'
                });
            } catch (e) {
                results.push({ test: 'å†œæˆ·ç™»å½•', passed: false, error: e.message });
            }
            
            // Test 4: Recycler Login
            try {
                const recycler = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'recycler001', password: 'recycler123' })
                });
                const recyclerData = await recycler.json();
                results.push({
                    test: 'å›æ”¶å•†ç™»å½•',
                    passed: recycler.ok && recyclerData.role === 'recycler'
                });
            } catch (e) {
                results.push({ test: 'å›æ”¶å•†ç™»å½•', passed: false, error: e.message });
            }
            
            // Test 5: Wrong Login
            try {
                const wrong = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: 'wronguser', password: 'wrongpass' })
                });
                results.push({
                    test: 'é”™è¯¯ç™»å½•æ‹¦æˆª',
                    passed: !wrong.ok
                });
            } catch (e) {
                results.push({ test: 'é”™è¯¯ç™»å½•æ‹¦æˆª', passed: false, error: e.message });
            }
            
            // Test 6: Get Orders
            try {
                const orders = await fetch(`${API_BASE}/api/orders`);
                const ordersData = await orders.json();
                results.push({
                    test: 'è®¢å•æŸ¥è¯¢',
                    passed: orders.ok && Array.isArray(ordersData)
                });
            } catch (e) {
                results.push({ test: 'è®¢å•æŸ¥è¯¢', passed: false, error: e.message });
            }
            
            // Test 7: Get Locations
            try {
                const locations = await fetch(`${API_BASE}/api/locations`);
                const locationsData = await locations.json();
                results.push({
                    test: 'åœ°ç‚¹æŸ¥è¯¢',
                    passed: locations.ok && Array.isArray(locationsData) && locationsData.length >= 3
                });
            } catch (e) {
                results.push({ test: 'åœ°ç‚¹æŸ¥è¯¢', passed: false, error: e.message });
            }
            
            // Display results
            const passed = results.filter(r => r.passed).length;
            const total = results.length;
            const passRate = ((passed / total) * 100).toFixed(1);
            
            let summary = `<h3>ğŸ“Š æµ‹è¯•ç»“æœæ±‡æ€»</h3>`;
            summary += `<p><strong>é€šè¿‡ç‡: ${passRate}% (${passed}/${total})</strong></p>`;
            summary += `<table style="width:100%; border-collapse: collapse;">`;
            summary += `<tr style="background:#f0f0f0;"><th style="padding:10px; text-align:left; border:1px solid #ddd;">æµ‹è¯•é¡¹</th><th style="padding:10px; text-align:center; border:1px solid #ddd;">ç»“æœ</th></tr>`;
            
            results.forEach(r => {
                const status = r.passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
                const bgColor = r.passed ? '#d4edda' : '#f8d7da';
                summary += `<tr style="background:${bgColor};"><td style="padding:10px; border:1px solid #ddd;">${r.test}</td><td style="padding:10px; text-align:center; border:1px solid #ddd;">${status}</td></tr>`;
                if (r.error) {
                    summary += `<tr><td colspan="2" style="padding:5px 10px; background:#fff3cd; border:1px solid #ddd; font-size:12px;">é”™è¯¯: ${r.error}</td></tr>`;
                }
            });
            
            summary += `</table>`;
            
            showResult('full-test-result', summary, passRate == 100 ? 'success' : 'error');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€
        window.onload = () => {
            checkBackendHealth();
        };
    </script>
</body>
</html>
